service: adaptive-api

plugins:
  - serverless-iam-roles-per-function
  - serverless-step-functions
  - serverless-export-env
  # - serverless-bundle
  # - serverless-esbuild

custom:
  name: vishal
  stage: ${opt:stage, self:provider.stage}
  logRetentionInDays: 30
  logLevel:
    default: ALL
    prod: ERROR

  appSyncLogLevel:
    default: ALL
    prod: ERROR
provider:
  name: aws
  runtime: nodejs20.x
  architecture: arm64 # Optional: for better performance
  stage: ${opt:stage, 'dev'}
  versionFunctions: false
  region: us-east-1
  memorySize: 512
  environment:
    NOTES_TABLE: !Ref NotesTable
    COHORT_TABLE: !Ref CohortTable
    FEATURE_TABLE: !Ref FeatureTableV2
    FEATURE_VERSION_TABLE: !Ref FeatureVersionTable
    USER_CREDENTIALS_TABLE: !Ref UserCredentialsTable
    API_KEYS_TABLE: !Ref ApiKeysTable
    TEAM_INVITATIONS_TABLE: !Ref TeamInvitationsTable
    TEAM_MEMBERS_TABLE: !Ref TeamMembersTable
    ADAPTIVE_KMS_ARN: !GetAtt AdaptiveKMSKey.Arn
    IDENTITY_TABLE: !Ref IdentityTableV2
    REGION: ${self:provider.region}
    STAGE: ${self:provider.stage}
    LOG_LEVEL: ${self:custom.logLevel.${self:provider.stage}, self:custom.logLevel.default}
    # NODE_OPTIONS: --enable-source-maps
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Scan
        - dynamodb:PutItem
        - dynamodb:Query
        - dynamodb:GetItem
        - dynamodb:UpdateItem
        - dynamodb:ListTables
        - dynamodb:DeleteItem
        - dynamodb:BatchWriteItem
        - dynamodb:BatchGetItem
      Resource: "*"
    - Effect: Allow
      Action:
        - ApiGateway:*
      Resource: "*"
    - Effect: Allow
      Action:
        - cloudformation:ValidateTemplate
        - cloudformation:CreateStack
        - cloudformation:ListStackResources
        - cloudformation:DescribeStackResource
        - cloudformation:DescribeStacks
      Resource: "*"
      
    - Effect: Allow
      Action: ssm:GetParameters
      Resource: "*"

    - Effect: Allow
      Action: events:*
      Resource: "*"
    - Effect: Allow
      Action:
        - s3:*
      Resource: "*"
    - Effect: Allow
      Action:
        - bedrock:InvokeModel
      Resource: "*"

functions:
  public-authorizer:
    timeout: 30
    handler: dist/functions/auth/public-authorizer.handler
    environment:
      USER_CREDENTIALS_TABLE: !Ref UserCredentialsTable
  authorizer:
    timeout: 30
    handler: dist/functions/auth/authorizer.handler
    environment:
      USER_CREDENTIALS_TABLE: !Ref UserCredentialsTable
  list-user-websites:
    timeout: 30
    handler: dist/functions/user-websites/list-user-websites.handler
    events:
      - http:
          path: /v1/list-user-websites
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      USER_CREDENTIALS_TABLE: !Ref UserCredentialsTable
  add-user-website:
    timeout: 30
    handler: dist/functions/user-websites/add-user-website.handler
    events:
      - http:
          path: /v1/add-user-website
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      USER_CREDENTIALS_TABLE: !Ref UserCredentialsTable
  update-user-website:
    timeout: 30
    handler: dist/functions/user-websites/update-user-website.handler
    events:
      - http:
          path: /v1/update-user-website
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      USER_CREDENTIALS_TABLE: !Ref UserCredentialsTable
  delete-user-website:
    timeout: 30
    handler: dist/functions/user-websites/delete-user-website.handler
    events:
      - http:
          path: /v1/delete-user-website
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      USER_CREDENTIALS_TABLE: !Ref UserCredentialsTable
  create-api-key:
    timeout: 30
    handler: dist/functions/api-keys/create-api-key.handler
    events:
      - http:
          path: /v1/create-api-key
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      API_KEYS_TABLE: !Ref ApiKeysTable
  list-api-keys:
    timeout: 30
    handler: dist/functions/api-keys/list-api-keys.handler
    events:
      - http:
          path: /v1/list-api-keys
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      API_KEYS_TABLE: !Ref ApiKeysTable
  get-api-key:
    timeout: 30
    handler: dist/functions/api-keys/get-api-key.handler
    events:
      - http:
          path: /v1/get-api-key
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      API_KEYS_TABLE: !Ref ApiKeysTable
  delete-api-key:
    timeout: 30
    handler: dist/functions/api-keys/delete-api-key.handler
    events:
      - http:
          path: /v1/delete-api-key
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      API_KEYS_TABLE: !Ref ApiKeysTable
  rotate-api-key:
    timeout: 30
    handler: dist/functions/api-keys/rotate-api-key.handler
    events:
      - http:
          path: /v1/rotate-api-key
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      API_KEYS_TABLE: !Ref ApiKeysTable
      ADAPTIVE_KMS_ARN: !GetAtt AdaptiveKMSKey.Arn
  confirmUserSignup:
    timeout: 30
    handler: dist/functions/user/confirm-user-signup.handler
    environment:
      USERS_TABLE: !Ref UsersTable
      USER_PREFERENCE_TABLE: !Ref UserPreferenceTable

  # ============================== Analytics Routes ===============================
  identify:
    timeout: 30
    handler: dist/functions/analytics/identify.handler
    events:
      - http:
          path: /v1/analytics/identify
          method: POST
          cors: true
          # authorizer:
          #   name: CognitoAuthorizer
          #   type: COGNITO_USER_POOLS
          #   arn: !GetAtt CognitoUserPool.Arn
    environment:
      IDENTITY_TABLE: !Ref IdentityTableV2
  add-events:
    timeout: 30
    handler: dist/functions/analytics/add-events.handler
    events:
      - http:
          path: /v1/analytics/add-events
          method: POST
          cors: true
          # authorizer:
          #   name: CognitoAuthorizer
          #   type: COGNITO_USER_POOLS
          #   arn: !GetAtt CognitoUserPool.Arn
    environment:
      EVENTS_TABLE: !Ref EventsTableV2
  add-feature:
    timeout: 30
    handler: dist/functions/analytics/feature/add-feature.handler
    events:
      - http:
          path: /v1/analytics/add-feature
          method: POST
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      FEATURE_TABLE: !Ref FeatureTableV2
  add-feature-version:
    timeout: 30
    handler: dist/functions/analytics/feature/add-feature-version.handler
    events:
      - http:
          path: /v1/analytics/add-feature-version
          method: POST
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      FEATURE_VERSION_TABLE: !Ref FeatureVersionTable
  remove-feature:
    timeout: 30
    handler: dist/functions/analytics/feature/remove-feature.handler
    events:
      - http:
          path: /v1/analytics/remove-feature
          method: POST
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      FEATURE_TABLE: !Ref FeatureTableV2
  list-features:
    timeout: 30
    handler: dist/functions/analytics/feature/list-features.handler
    events:
      - http:
          path: /v1/analytics/list-features
          method: POST
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      FEATURE_TABLE: !Ref FeatureTableV2
  get-feature-details:
    timeout: 30
    handler: dist/functions/analytics/feature/get-feature-details.handler
    events:
      - http:
          path: /v1/analytics/get-feature-details
          method: POST
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    environment:
      FEATURE_TABLE: !Ref FeatureTableV2
  is-feature-enabled:
    timeout: 30
    handler: dist/functions/analytics/feature/is-feature-enabled.handler
    events:
      - http:
          path: /v1/feature/is-enabled
          method: POST
          cors: true
          # authorizer:
          #   name: CognitoAuthorizer
          #   type: COGNITO_USER_POOLS
          #   arn: !GetAtt CognitoUserPool.Arn

    environment:
      FEATURE_TABLE: !Ref FeatureTableV2
  has-user-events:
    timeout: 30
    handler: dist/functions/analytics/has-user-events.handler
    events:
      - http:
          path: /v1/analytics/has-user-events
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  get-summary:
    timeout: 30
    handler: dist/functions/analytics/get-summary/get-summary.handler
    events:
      - http:
          path: /v1/analytics/get-summary
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  get-live-users:
    timeout: 30
    handler: dist/functions/analytics/get-live-users/get-live-users.handler
    events:
      - http:
          path: /v1/analytics/get-live-users
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  get-live-users-public:
    timeout: 30
    handler: dist/functions/analytics/get-live-users/get-live-users-public.handler
    events:
      - http:
          path: /v0/analytics/get-live-users
          method: post
          cors: true
          # authorizer:
          #   name: CognitoAuthorizer
          #   type: COGNITO_USER_POOLS
          #   arn: !GetAtt CognitoUserPool.Arn
  list-events-by-email:
    timeout: 30
    handler: dist/functions/analytics/list-events-by-email/list-events-by-email.handler
    events:
      - http:
          path: /v1/analytics/list-events-by-email
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  get-user-info:
    timeout: 30
    handler: dist/functions/analytics/get-user-info/get-user-info.handler
    events:
      - http:
          path: /v1/analytics/get-user-info
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  get-total-visitors-by:
    timeout: 30
    handler: dist/functions/analytics/list-total-visitors-by/list-total-visitors-by.handler
    events:
      - http:
          path: /v1/analytics/get-total-visitors-by
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  list-metadatas:
    timeout: 30
    handler: dist/functions/analytics/list-metadatas/list-metadatas.handler
    events:
      - http:
          path: /v1/analytics/list-metadatas
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  list-selected-attribute-values:
    timeout: 30
    handler: dist/functions/analytics/list-attribute-values/list-attribute-values.handler
    events:
      - http:
          path: /v1/analytics/list-attribute-values
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  add-cohort:
    timeout: 30
    handler: dist/functions/analytics/cohort/add-cohort.handler
    events:
      - http:
          path: /v1/analytics/add-cohort
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  list-cohorts:
    timeout: 30
    handler: dist/functions/analytics/cohort/list-cohorts.handler
    events:
      - http:
          path: /v1/analytics/list-cohorts
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  delete-cohort:
    timeout: 30
    handler: dist/functions/analytics/cohort/delete-cohort.handler
    events:
      - http:
          path: /v1/analytics/delete-cohort
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  list-cohort-users:
    timeout: 30
    handler: dist/functions/analytics/cohort/list-cohort-users.handler
    events:
      - http:
          path: /v1/analytics/list-cohort-users
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  list-journeys:
    timeout: 30
    handler: dist/functions/analytics/list-journeys/list-journeys.handler
    events:
      - http:
          path: /v1/analytics/list-journeys
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  # ============================== Analytics Routes End ===============================
  # ============================== Notes Routes Start =================================
  add-note:
    timeout: 30
    handler: dist/functions/analytics/note/add-note.handler
    events:
      - http:
          path: /v1/analytics/add-note
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
    list-notes:
      timeout: 30
      handler: dist/functions/analytics/note/list-notes.handler
      events:
        - http:
            path: /v1/analytics/list-notes
            method: post
            cors: true
            authorizer:
              name: CognitoAuthorizer
              type: COGNITO_USER_POOLS
              arn: !GetAtt CognitoUserPool.Arn
    # ============================== Notes Routes End =================================
  # ============================== Team Routes Start ====================
  create-team:
    timeout: 30
    handler: dist/functions/teams/create-team.handler
    events:
      - http:
          path: /v1/teams
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  list-team-members-by-website-id:
    timeout: 30
    handler: dist/functions/team-members/list-team-members-by-website-id.handler
    events:
      - http:
          path: /v1/websites/{websiteId}/team-members
          method: get
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  # ============================== Team Routes End ====================
  # ============================== Team Invitations Routes Start ====================
  create-team-invitation:
    timeout: 30
    handler: dist/functions/team-invitations/create-team-invitation.handler
    events:
      - http:
          path: /v1/team-invitations
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  list-team-invitations:
    timeout: 30
    handler: dist/functions/team-invitations/list-team-invitations.handler
    events:
      - http:
          path: /v1/team-invitations
          method: get
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  update-invitation-status:
    timeout: 30
    handler: dist/functions/team-invitations/update-invitation-status.handler
    events:
      - http:
          path: /v1/team-invitations/status
          method: put
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  verify-invitation-token:
    timeout: 30
    handler: dist/functions/team-invitations/verify-invitation-token.handler
    events:
      - http:
          path: /v1/team-invitations/verify
          method: post
          cors: true
          # Note: This endpoint is public - users can access before authentication
  accept-invitation:
    timeout: 30
    handler: dist/functions/team-invitations/accept-invitation.handler
    events:
      - http:
          path: /v1/team-invitations/accept
          method: post
          cors: true
          authorizer:
            name: CognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: !GetAtt CognitoUserPool.Arn
  # ============================== Team Invitations Routes End ======================
resources:
  Resources:
    CohortTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: websiteId
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: byWebsiteId
            KeySchema:
              - AttributeName: websiteId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: cohort-table
    UserCredentialsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: byUserId
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: credentials-table
    AdaptiveKMSKey:
      Type: AWS::KMS::Key
      Properties:
        Description: "Adaptive KMS Key"
        Enabled: true
        KeyPolicy:
          Id: "key-lambda-1"
          Statement:
            Sid: "Allow administration of the key"
            Effect: "Allow"
            Principal:
              AWS: "*"
            Action: "kms:*"
            Resource: "*"
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: false
            RequireNumbers: false
            RequireUppercase: false
            RequireSymbols: false
        UsernameAttributes:
          - email
        LambdaConfig:
          PostConfirmation: !GetAtt ConfirmUserSignupLambdaFunction.Arn

    # 3. AWS Cognito User Pool Client
    WebUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        UserPoolId: !Ref CognitoUserPool
        ClientName: web
        ExplicitAuthFlows:
          - ALLOW_USER_SRP_AUTH
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_CUSTOM_AUTH
        PreventUserExistenceErrors: ENABLED

    # 7. AWS  Lambda Permission
    CognitoUserPoolConfirmUserSignupLambdaPermission:
      Type: AWS::Lambda::Permission
      Properties:
        Action: lambda:invokeFunction
        FunctionName: !Ref ConfirmUserSignupLambdaFunction
        Principal: cognito-idp.amazonaws.com
        SourceArn: !GetAtt CognitoUserPool.Arn

    UserPreferenceTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        Tags:
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: user-preference-table

    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S
          - AttributeName: id
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: byEmail
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          # To keep track of user table for diffeent environment
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: users-table
    IdentityTableV2:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
          - AttributeName: emailAndDeviceType
            AttributeType: S
          - AttributeName: websiteId
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: byWebsiteId
            KeySchema:
              - AttributeName: websiteId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: byEmail
            KeySchema:
              - AttributeName: email
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: byEmailAndDeviceType
            KeySchema:
              - AttributeName: emailAndDeviceType
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          # To keep track of user table for diffeent environment
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: identity-table
    EventsTableV2:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
          - AttributeName: websiteId
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: byEmail
            KeySchema:
              - AttributeName: email
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: byWebsiteId
            KeySchema:
              - AttributeName: websiteId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          # To keep track of user table for diffeent environment
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: events-table
    FeatureTableV2:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: websiteId
            AttributeType: S
          - AttributeName: featureKeyAndWebsiteId
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: byWebsiteId
            KeySchema:
              - AttributeName: websiteId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: byFeatureKeyAndWebsiteId
            KeySchema:
              - AttributeName: featureKeyAndWebsiteId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          # To keep track of user table for diffeent environment
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: features-table
    FeatureVersionTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: featureId
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: byFeatureId
            KeySchema:
              - AttributeName: featureId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          # To keep track of user table for diffeent environment
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: feature-versions-table
    NotesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: websiteId
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: byWebsiteId
            KeySchema:
              - AttributeName: websiteId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          # To keep track of user table for diffeent environment
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: notes-table
    ApiKeysTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: websiteId
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: byWebsiteId
            KeySchema:
              - AttributeName: websiteId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: api-keys-table
    TeamInvitationsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: websiteId
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: by-website
            KeySchema:
              - AttributeName: websiteId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: by-email
            KeySchema:
              - AttributeName: email
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: by-email-website
            KeySchema:
              - AttributeName: email
                KeyType: HASH
              - AttributeName: websiteId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: team-invitations-table
    TeamMembersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: websiteId
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        GlobalSecondaryIndexes:
          - IndexName: by-website
            KeySchema:
              - AttributeName: websiteId
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: by-email
            KeySchema:
              - AttributeName: email
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: team-members-table
